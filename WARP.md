# WARP.md

This file provides guidance to WARP (warp.dev) when working with code in this repository.

## Development Commands

### Core Development
```bash
pnpm dev          # Start development server on http://localhost:3000
pnpm build        # Build for production
pnpm start        # Start production server
pnpm devsafe      # Clean .next and start dev (when build issues occur)
```

### Payload CMS Operations
```bash
pnpm generate:types        # Generate TypeScript types from Payload collections
pnpm generate:importmap    # Generate import map for admin UI
pnpm migrate:create        # Create new database migration
pnpm payload               # Run Payload CLI commands
pnpm ci                    # Full CI pipeline: migrate, generate types/importmap, build
```

### Code Quality
```bash
pnpm lint         # Run ESLint
```

### Running Single Operations
- **Admin Panel**: Navigate to `/admin` after starting dev server
- **Database Migration**: Run `pnpm payload migrate` to sync schema changes
- **Type Generation**: Run after modifying any Payload collection definitions

## Architecture Overview

### Tech Stack
- **Frontend**: Next.js 15 with App Router + React 19 + TypeScript
- **Backend/CMS**: Payload CMS 3.0 with built-in authentication and API generation
- **Database**: Vercel Postgres with automatic schema management
- **UI Framework**: shadcn/ui components built on Radix UI primitives
- **Styling**: Tailwind CSS with custom design system
- **Media Storage**: Vercel Blob (preferred) or S3 fallback
- **Email**: Nodemailer with Gmail integration

### Directory Structure
```
src/
├── app/
│   ├── (frontend)/          # Public-facing Next.js pages
│   ├── (payload)/           # Payload admin panel customizations
│   └── api/                 # Custom API routes
├── collections/             # Payload CMS collection definitions
│   ├── access/              # Access control patterns and utilities
│   ├── Users.ts             # User authentication and roles
│   ├── Items.ts             # Product catalog
│   ├── Orders.ts            # Order management
│   ├── Categories.ts        # Product categories
│   ├── Reviews.ts           # Product reviews
│   └── Media.ts             # File uploads and media management
├── components/
│   ├── ui/                  # shadcn/ui components (DO NOT MODIFY)
│   └── *                    # Custom application components
├── lib/                     # Utilities and shared logic
├── payload.config.ts        # Main Payload configuration
└── payload-types.ts         # Auto-generated types (DO NOT MODIFY)
```

### Key Architecture Patterns

#### Access Control System
- Centralized in `src/collections/access/index.ts`
- Role-based permissions: `admin` and `user` roles
- Access patterns: `anyone`, `authenticated`, `admins`, `adminsOrSelf`, `adminsOrOwner`
- Always validate permissions server-side using Payload's access control

#### Data Flow
1. **Frontend**: Next.js App Router with server/client components
2. **API Layer**: Payload's auto-generated REST/GraphQL APIs + custom routes
3. **Database**: PostgreSQL via Vercel Postgres adapter
4. **Authentication**: Payload's built-in JWT-based auth system

#### State Management
- **Global State**: React Context API (cart functionality)
- **CMS Data**: Payload's built-in state management
- **Forms**: React Hook Form with Zod validation
- **UI State**: Local React state (useState/useReducer)

### Critical Files (Never Modify)
- `src/payload-types.ts` - Auto-generated by Payload, will be overwritten
- `src/migrations/` - Database migration files, modify with extreme caution
- `src/components/ui/` - shadcn/ui components, regenerate via CLI instead

### Collections Architecture
- **Users**: Authentication, roles (admin/user), customer information, address management
- **Items**: Product catalog with media relations, categories, pricing, availability
- **Orders**: Enhanced order management with 6-status tracking (pending→processing→shipped→completed/cancelled/refunded)
- **Categories**: Hierarchical product categorization system
- **Reviews**: Product review and rating system with moderation
- **Media**: File uploads with Sharp optimization, Vercel Blob/S3 integration

### Enhanced Order Status System
- **Interactive Dropdown**: Admin can change status directly from list view
- **Real-time Updates**: Status changes immediately update database and UI
- **Email Notifications**: Automatic customer notifications in Bangla, admin alerts in English
- **Visual Feedback**: Color-coded status badges with emojis and loading states
- **Status Workflow**: pending → processing → shipped → completed/cancelled/refunded

### Security Model
- **Role-based access**: Least privilege principle with explicit permissions
- **Server-side validation**: Never trust client data
- **Authentication required**: Protected routes use Payload's auth middleware
- **Data isolation**: Users can only access their own orders/data (except admins)

## Development Guidelines

### Working with Collections
- Use Payload's Local API for server-side operations
- Always use proper TypeScript types from `payload-types.ts`
- Handle relationships with Payload's depth parameter
- Use access control patterns instead of custom middleware

### Admin Component Development
- **OrderStatusDropdown.tsx**: Interactive dropdown for real-time status updates
- **OrderStatusNotifications.tsx**: Toast notification system with custom events
- **GlobalNotificationProvider.tsx**: Admin-wide notification injection
- Custom components use React.FC with proper TypeScript interfaces
- Status updates trigger email notifications via hooks/orderStatusUpdate.ts

### UI Development
- Always use shadcn/ui components from `@/components/ui/`
- Use Tailwind CSS exclusively for styling
- Follow responsive-first design principles
- Use Lucide React for all icons

### API Development
- Leverage Payload's auto-generated APIs when possible
- Custom API routes in `src/app/api/` for business logic
- Always validate user authentication and authorization
- Return proper HTTP status codes and error messages

### Environment Setup
Required environment variables:
- `PAYLOAD_SECRET` - Payload CMS secret key
- `POSTGRES_URL` - Database connection string
- `BLOB_READ_WRITE_TOKEN` - Vercel Blob storage (preferred)
- `S3_*` - S3 credentials (fallback storage)
- `GMAIL_USER` / `GOOGLE_APP_PASSWORD` - Email configuration

### AI Development Rules
The project includes comprehensive AI development guidelines in `AI_RULES.md` covering:
- Tech stack integration patterns
- Access control security principles
- File modification restrictions
- Code style and TypeScript usage
- Library usage rules (shadcn/ui, Tailwind CSS)
- Payload CMS integration best practices

### User Roles and Permissions
- **Regular Users (`role: 'user'`)**: Browse products, place orders, view order history
- **Admin Users (`role: 'admin'`)**: All user permissions + order management, inventory control, CMS access

### Development Workflow
1. Start with `pnpm dev` for development server
2. Access admin panel at `/admin` to manage content
3. Use `pnpm generate:types` after modifying collections
4. Test authentication flows with both user and admin accounts
5. Validate access control before deploying changes